<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
  <title>Novo Snippet</title>
  <th:block th:replace="~{fragments :: head-common}"></th:block>
  <style>
    #monaco-container {
      width: 100%;
      height: 400px;
      border: 1px solid #444;
      border-radius: 0 0 6px 6px;
      overflow: hidden;
    }
  </style>
</head>
<body>

<h1 class="codesv-title">CodeSV</h1>

<div class="codesv-window">
  <div class="window-controls">
    <span class="dot red"></span>
    <span class="dot yellow"></span>
    <span class="dot green"></span>
  </div>

  <h2 class="text-white mb-4"
      th:text="${snippetId} == null ? 'Criar Snippet' : 'Editar Snippet'">
    Criar Snippet
  </h2>

  <div th:if="${error}" class="alert alert-warning alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}">Erro</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <form id="snippetForm"
        th:action="${snippetId} == null ? @{/snippets/save} : @{/snippets/{id}/update(id=${snippetId})}"
        th:object="${snippetForm}"
        method="post">

    <div class="mb-3">
      <label class="form-label">Título</label>
      <input type="text" th:field="*{title}" class="form-control" placeholder="Ex: Algoritmo de Busca Binária">
      <div class="text-danger mt-1" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Linguagem</label>
      <select id="languageSelect" th:field="*{language}" class="form-select">
        <option value="">Selecione...</option>
        <option value="java">Java</option>
        <option value="python">Python</option>
        <option value="javascript">JavaScript</option>
        <option value="cpp">C++</option>
        <option value="sql">SQL</option>
      </select>
      <div class="text-danger mt-1" th:if="${#fields.hasErrors('language')}" th:errors="*{language}"></div>
    </div>

    <div class="mb-3">
      <label class="form-label">Visibilidade</label>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="visibility" th:field="*{publicSnippet}">
        <label class="form-check-label" for="visibility">Marcar como público</label>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Código</label>

      <div id="monaco-container"></div>

      <input type="hidden" id="content-hidden" th:field="*{content}">

      <div class="text-danger mt-1" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <a href="/snippets" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success"
              th:text="${snippetId} == null ? 'Salvar Snippet' : 'Atualizar Snippet'">
        Salvar Snippet
      </button>
    </div>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

<script>
  require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});

  require(['vs/editor/editor.main'], function() {

    monaco.editor.defineTheme('codesv-dark', {
      base: 'vs-dark',
      inherit: true,
      rules: [
        { token: 'comment', foreground: '5C6370', fontStyle: 'italic' },
        { token: 'comment.doc', foreground: '5C6370', fontStyle: 'italic' },

        { token: 'keyword', foreground: 'C678DD', fontStyle: 'bold' },
        { token: 'keyword.control', foreground: 'C678DD', fontStyle: 'bold' },
        { token: 'operator', foreground: '56B6C2' },
        { token: 'delimiter', foreground: 'ABB2BF' },

        { token: 'type', foreground: 'E5C07B' },
        { token: 'class', foreground: 'E5C07B' },
        { token: 'interface', foreground: 'E5C07B' },
        { token: 'type.identifier', foreground: 'E5C07B' },

        { token: 'function', foreground: '61AFEF' },
        { token: 'member', foreground: '61AFEF' },
        { token: 'method', foreground: '61AFEF' },

        { token: 'variable', foreground: 'E06C75' },
        { token: 'variable.parameter', foreground: 'E06C75' },
        { token: 'identifier', foreground: 'ABB2BF' },

        { token: 'string', foreground: '98C379' },
        { token: 'number', foreground: 'D19A66' },
        { token: 'regexp', foreground: '98C379' },

        { token: 'tag', foreground: 'E06C75' },
        { token: 'attribute.name', foreground: 'D19A66' },
        { token: 'annotation', foreground: 'D19A66' }
      ],
      colors: {
        'editor.background': '#1e1e1e',
        'editor.foreground': '#ABB2BF',
        'editor.lineHighlightBackground': '#2C313C',
        'editorLineNumber.foreground': '#4B5263',
        'editorCursor.foreground': '#528BFF',
        'editor.selectionBackground': '#3E4451',
        'editorIndentGuide.background': '#3b4048'
      }
    });

    var initialValue = document.getElementById('content-hidden').value;
    var initialLanguage = document.getElementById('languageSelect').value || 'plaintext';

    var languageMap = {
      'java': 'java', 'python': 'python', 'javascript': 'javascript',
      'cpp': 'cpp', 'sql': 'sql', '': 'plaintext'
    };

    var editor = monaco.editor.create(document.getElementById('monaco-container'), {
      value: initialValue,
      language: languageMap[initialLanguage],
      theme: 'codesv-dark',

      'semanticHighlighting.enabled': true, // Força a tentativa de highlight semântico

      fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
      fontSize: 15,
      fontLigatures: true,
      lineHeight: 24,

      minimap: { enabled: false },
      scrollBeyondLastLine: false,
      roundedSelection: true,
      cursorBlinking: 'smooth',
      cursorSmoothCaretAnimation: 'on',

      padding: { top: 20, bottom: 20 },

      overviewRulerLanes: 0,
      hideCursorInOverviewRuler: true,
      overviewRulerBorder: false,

      scrollbar: {
        vertical: 'auto',
        horizontal: 'hidden',
        useShadows: false,
        verticalScrollbarSize: 10
      }
    });

    // Lógica de Sincronização
    document.getElementById('languageSelect').addEventListener('change', function() {
      var monacoLang = languageMap[this.value] || 'plaintext';
      monaco.editor.setModelLanguage(editor.getModel(), monacoLang);
    });

    document.getElementById('snippetForm').addEventListener('submit', function() {
      document.getElementById('content-hidden').value = editor.getValue();
    });

    window.addEventListener('resize', function() {
      editor.layout();
    });

  });
</script>

<footer th:replace="~{fragments :: footer}"></footer>

</body>
</html>